#!/bin/bash

set -eu

function can_docker() {
    if [[ -r /var/run/docker.sock ]]; then
        return 0
    else
        return 1
    fi
}

function join_by { local IFS="$1"; shift; echo "$*"; }
# from https://stackoverflow.com/questions/1527049/join-elements-of-an-array

cdemo_container_names=(
    splunk
    jenkins
    gogs
    conjur-master
    conjur-cli
    weavescope
)

function cdemo_containers() {
    docker ps -a \
           --filter="name=$(join_by '|' ${cdemo_container_names[@]})" \
           --format={{.Names}} \
           | tr "\n" " "
}

if can_docker; then
    targets=$(cdemo_containers)
    if [[ -z $targets ]]; then
        echo "remove-containers: no cdemo Docker containers to remove"
        exit 0
    fi
    echo "Removing cdemo Docker containers..."
    docker rm -f $targets
else
    echo "remove-containers: fatal: user \"$(whoami)\" lacks permission to use Docker"
fi

echo "Removing Ansible Tower..."
clean_tower

function clean_tower(){
  yum remove anisble-tower\*
  yum -y remove rabbitmq-server
  rm -rf /etc/tower /var/lib/{pgsql,awx,rabbitmq}
  yum remove -y ansible-tower-*
  yum remove -y postgresql*
  yum remove -y nginx*
  rm -rf /etc/nginx
  rm -rf /opt/ansible*
}